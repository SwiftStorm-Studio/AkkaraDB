# Build

Instructions for building AkkaraDB from source.

## ðŸ“š Table of Contents

- [Prerequisites](#prerequisites)
- [Clone Repository](#clone-repository)
- [Build Instructions](#build-instructions)
- [Run Tests](#run-tests)
- [Module Structure](#module-structure)
- [IDE Setup](#ide-setup)
- [Troubleshooting](#troubleshooting)
- [Development Guidelines](#development-guidelines)

---

## Prerequisites

### Required

- **JDK 17 or higher**
  ```bash
  java -version
  # openjdk version "17.0.1" 2021-10-19
  ```

- **Git**
  ```bash
  git --version
  # git version 2.34.1
  ```

### Recommended

- **Kotlin 2.2.21** (automatically downloaded by Gradle)
- **IntelliJ IDEA 2024.1 or higher** (when using IDE)

---

## Clone Repository

```bash
# Clone via HTTPS
git clone https://github.com/SwiftStorm-Studio/AkkaraDB.git
cd AkkaraDB

# Or clone via SSH
git clone git@github.com:SwiftStorm-Studio/AkkaraDB.git
cd AkkaraDB
```

### Branch Structure

```
main       : Stable (for releases)
dev        : Other (relics of the past)
```

To participate in development, checkout the `main` branch:

```bash
git checkout main
```

---

## Build Instructions

### Build All Modules

Run the following at the project root to build all modules and generate artifacts:

```bash
# Use Gradle wrapper (recommended)
./gradlew build

# Windows
gradlew.bat build
```

**Output:**

```
BUILD SUCCESSFUL in 45s
127 actionable tasks: 127 executed
```

**Main Artifacts (generated by root build):**

- `akkara/akkaradb/build/libs/akkaradb-0.2.9.jar` - Fat JAR (includes all dependencies)
- `akkara/akkaradb/build/libs/akkaradb-0.2.9-thin.jar` - Thin JAR (no dependencies)
- `akkara/akkaradb/build/libs/akkaradb-0.2.9-sources.jar` - Sources JAR

**Plugin Artifacts:**

- `akkara/plugin/akkara-plugin/build/libs/akkara-plugin-0.1.0.jar` - Gradle plugin
- `akkara/plugin/akkara-compiler/build/libs/akkara-compiler-0.3.9.jar` - Kotlin compiler plugin

---

### Clean Build

```bash
# Delete all generated files and rebuild
./gradlew clean build
```

---

### Offline Build (without dependencies)

```bash
# Download dependencies first
./gradlew build --refresh-dependencies

# Offline build
./gradlew build --offline
```

---

## Run Tests

### Run All Tests

```bash
./gradlew test
```

**Example Output:**

```
> Task :akkara-engine:test
AkkaraDBTest > testPutAndGet() PASSED
AkkaraDBTest > testDelete() PASSED
AkkaraDBTest > testCompareAndSwap() PASSED
MemTableTest > testConcurrentWrites() PASSED
...

BUILD SUCCESSFUL in 12s
```

---

### Test Specific Module

```bash
# Engine module only
./gradlew :akkara-engine:test

# Common module only
./gradlew :akkara-common:test
```

---

### View Test Report

```bash
# After running tests, open the report (macOS)
open akkara/engine/build/reports/tests/test/index.html

# Linux
xdg-open akkara/engine/build/reports/tests/test/index.html

# Windows
start akkara/engine/build/reports/tests/test/index.html
```

---

## Module Structure

AkkaraDB consists of the following modules:

### Core Modules

```
akkara/
â”œâ”€â”€ common/              # Basic primitives (ByteBufferL, LE, types)
â”œâ”€â”€ format-api/          # Format API (BlockPacker, StripeWriter, etc.)
â”œâ”€â”€ format-akk/          # AKK implementation (AkkBlockPacker, parity coders)
â”œâ”€â”€ engine/              # Storage engine (MemTable, WAL, SSTable, etc.)
â””â”€â”€ akkaradb/            # Integration module (Fat JAR generation)
```

### Plugin Modules

```
akkara/plugin/
â”œâ”€â”€ akkara-plugin/       # Gradle plugin
â””â”€â”€ akkara-compiler/     # Kotlin compiler plugin (IR transformation)
```

---

### Module Dependencies

```
akkaradb (Fat JAR)
  â”œâ”€ engine
  â”‚   â”œâ”€ common
  â”‚   â”œâ”€ format-api
  â”‚   â””â”€ format-akk
  â”‚       â””â”€ common
  â”œâ”€ format-api
  â”‚   â””â”€ common
  â””â”€ format-akk
      â””â”€ common

akkara-compiler
  â””â”€ kotlin-compiler (compileOnly)

akkara-plugin
  â””â”€ gradle-plugin-api (compileOnly)
```

---

### Individual Module Build

You can also build individual modules:

#### akkara-common

```bash
./gradlew :akkara-common:build
```

**Artifact:** `akkara/common/build/libs/akkara-common-0.0.0+dev-YYYYMMDD-HHmmss.jar`

---

#### akkara-engine

```bash
./gradlew :akkara-engine:build
```

**Artifact:** `akkara/engine/build/libs/akkara-engine-0.0.0+dev-YYYYMMDD-HHmmss.jar`

---

#### akkaradb (Integration Module)

Generate Fat JAR:

```bash
./gradlew :akkaradb:shadowJar
```

**Artifact:** `akkara/akkaradb/build/libs/akkaradb-0.2.9.jar`

**Excluded Dependencies:**

- Kotlin standard library (expected in runtime)
- Kotlinx libraries
- JetBrains annotations

---

#### Plugins

```bash
# Gradle plugin
./gradlew :akkara-plugin:build

# Compiler plugin
./gradlew :akkara-compiler:build
```

---

## IDE Setup

### IntelliJ IDEA

#### Import Project

1. Launch IntelliJ IDEA
2. `File` â†’ `Open...`
3. Select the `AkkaraDB` directory
4. Click `Trust Project`

IntelliJ automatically recognizes the Gradle project and downloads dependencies.

---

#### Configure Kotlin Plugin

1. `File` â†’ `Settings` â†’ `Plugins`
2. Search and install `Kotlin` (usually pre-installed)
3. Verify version: 2.2.21 or higher

---

#### Compiler Settings

`File` â†’ `Settings` â†’ `Build, Execution, Deployment` â†’ `Compiler` â†’ `Kotlin Compiler`

```
Language version: 2.1
API version: 2.1
JVM target: 17
```

---

#### Gradle JVM Settings

`File` â†’ `Settings` â†’ `Build, Execution, Deployment` â†’ `Build Tools` â†’ `Gradle`

```
Gradle JVM: 17 (Recommended: Amazon Corretto 17 or OpenJDK 17)
Build and run using: Gradle
Run tests using: Gradle
```

---

#### Recommended Plugins

- **Kotlin** (required)
- **Gradle** (required)
- **GitToolBox** (useful)
- **Rainbow Brackets** (useful)

---

### Visual Studio Code

#### Install Extensions

```json
// .vscode/extensions.json
{
  "recommendations": [
    "mathiasfrohlich.kotlin",
    "vscjava.vscode-java-pack",
    "vscjava.vscode-gradle"
  ]
}
```

Install:

```bash
code --install-extension mathiasfrohlich.kotlin
code --install-extension vscjava.vscode-java-pack
code --install-extension vscjava.vscode-gradle
```

---

#### Configure Tasks

```json
// .vscode/tasks.json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Build AkkaraDB",
      "type": "shell",
      "command": "./gradlew build",
      "group": {
        "kind": "build",
        "isDefault": true
      }
    },
    {
      "label": "Test AkkaraDB",
      "type": "shell",
      "command": "./gradlew test",
      "group": "test"
    }
  ]
}
```

---

## Troubleshooting

### Build Error: "Cannot find symbol ByteBufferL"

**Cause:** Module dependencies not resolved

**Solution:**

```bash
./gradlew clean build --refresh-dependencies
```

---

### Build Error: "Kotlin compiler version mismatch"

**Cause:** IDE Kotlin version differs from project version

**Solution:**

```bash
# Check version in gradle/libs.versions.toml
cat gradle/libs.versions.toml | grep "kotlin"

# Update Kotlin plugin in IntelliJ
# File â†’ Settings â†’ Plugins â†’ Kotlin â†’ Update
```

**Current Version:** Kotlin 2.2.21

---

### Test Failure: "WAL replay failed"

**Cause:** Data from previous test run remains

**Solution:**

```bash
# Clean test data directory
rm -rf akkara/engine/build/test-data
./gradlew clean test
```

---

### Out of Memory Error

**Cause:** Gradle daemon insufficient memory

**Solution:**

```bash
# Add to gradle.properties
echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m" >> gradle.properties

# Restart Gradle daemon
./gradlew --stop
./gradlew build
```

---

### Compiler Plugin Error: "IR lowering failed"

**Cause:** `kotlin.compiler.execution.strategy` not configured

**Solution:**

```bash
# Add to gradle.properties
echo "kotlin.compiler.execution.strategy=in-process" >> gradle.properties
./gradlew clean build
```

For details, see [Installation](./INSTALLATION.md#-compiler-plugin-configuration-required).

---

## Development Guidelines

### Coding Style

AkkaraDB follows Kotlin standard coding conventions:

```kotlin
// Class names: PascalCase
class MemTable

// Function names: camelCase
fun put(key: ByteBufferL, value: ByteBufferL)

// Constants: UPPER_SNAKE_CASE
const val BLOCK_SIZE = 32 * 1024

// Private variables: camelCase
private val sealed = AtomicBoolean(false)
```

---

### Version Management

Each module has different versions:

```kotlin
// build.gradle.kts
version = when (name) {
    "akkaradb" -> "0.2.9"           // Main artifact
    "akkara-plugin" -> "0.1.0"       // Gradle plugin
    "akkara-compiler" -> "0.3.9"     // Compiler plugin
    else -> "0.0.0+dev-${timestamp}" // Development version
}
```

---

### Commit Message Convention

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type:**

- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation
- `style`: Formatting (no code behavior change)
- `refactor`: Refactoring
- `perf`: Performance improvement
- `test`: Add/fix tests
- `chore`: Build process/tooling

**Example:**

```
feat(engine): add compareAndSwap support

Implement CAS operation for MemTable with WAL durability.
Includes retry logic for concurrent updates.

Closes #123
```

---

### Pull Request

**Checklist:**

- [ ] Code follows conventions
- [ ] Tests added
- [ ] All tests pass
- [ ] Documentation updated (if needed)
- [ ] Commit messages follow convention

**Template:**

```markdown
## Summary

<!-- Brief description of changes -->

## Reason

<!-- Why is this change needed -->

## Details

<!-- Technical details -->

## Testing

<!-- How was this tested -->

## Related Issues

Closes #XXX
```

---

### Local Publish Test

```bash
# Publish to Maven Local
./gradlew publishToMavenLocal

# Verify artifacts
ls ~/.m2/repository/dev/swiftstorm/akkaradb/0.2.9/

# Test reference from another project
dependencies {
    implementation("dev.swiftstorm:akkaradb:0.2.9")
}
```

---

### Debug Build

```bash
# Increase log level
./gradlew build --debug

# Show stack trace
./gradlew build --stacktrace

# Info level
./gradlew build --info
```

---

## Publishing

### Publish All Modules

```bash
# Publish to Maven repository
./gradlew publishAllModule
```

This task publishes the following modules:

- `akkaradb` (v0.2.9)
- `akkara-plugin` (v0.1.0)
- `akkara-compiler` (v0.3.9)

---

### Publish Destination

```kotlin
repositories {
    maven {
        val releasesRepoUrl = uri("https://repo.swiftstorm.dev/maven2-rel/")
        val snapshotsRepoUrl = uri("https://repo.swiftstorm.dev/maven2-snap/")
        url = if (version.toString().endsWith("SNAPSHOT"))
            snapshotsRepoUrl
        else
            releasesRepoUrl
    }
}
```

---

### Prevent Duplicate Publishing

AkkaraDB checks artifact existence via HTTP HEAD before publishing to avoid overwriting:

```kotlin
tasks.withType<PublishToMavenRepository>().configureEach {
    onlyIf {
        val artifactUrl = "${repoRoot}${groupPath}/$artifactId/$ver/$artifactId-$ver.jar"
        val exists = checkArtifactExists(artifactUrl)

        if (exists) {
            logger.lifecycle("Artifact already exists, skipping publish.")
            false
        } else {
            true
        }
    }
}
```

---

## Release Process

### Versioning

Each module is versioned independently:

```
akkaradb:       0.2.9  (Main library)
akkara-plugin:  0.1.0  (Gradle plugin)
akkara-compiler: 0.3.9 (Compiler plugin)
```

Follows Semantic Versioning (SemVer):

```
MAJOR.MINOR.PATCH

Examples:
0.2.9  - Patch release (bug fix)
0.3.0  - Minor release (new features, backward compatible)
1.0.0  - Major release (breaking changes)
```

---

### Release Procedure

```bash
# 1. Update version
# Update version in build.gradle.kts

# 2. Update CHANGELOG
echo "## [0.2.10] - 2025-01-15
### Added
- New feature X
### Fixed
- Bug Y" >> CHANGELOG.md

# 3. Commit & tag
git add build.gradle.kts CHANGELOG.md
git commit -m "chore: release v0.2.10"
git tag v0.2.10

# 4. Push
git push origin main
git push origin v0.2.10

# 5. Publish
./gradlew publishAllModule
```

---

## Contributing

Contributions to AkkaraDB are welcome!

### Bug Reports

Report bugs on [GitHub Issues](https://github.com/SwiftStorm-Studio/AkkaraDB/issues):

```markdown
**Environment:**

- OS: Ubuntu 22.04
- JDK: OpenJDK 17
- AkkaraDB: v0.2.9

**Steps to Reproduce:**

1. ...
2. ...

**Expected Behavior:**
...

**Actual Behavior:**
...

**Logs:**
...
```

---

### Feature Requests

Propose features on [GitHub Discussions](https://github.com/SwiftStorm-Studio/AkkaraDB/discussions):

```markdown
**Feature Description:**
...

**Use Cases:**
...

**Alternatives:**
...
```

---

### Pull Requests

1. Create an issue (if not already existing)
2. Fork from `main` branch
3. Create `feature/your-feature` branch
4. Implement changes
5. Add tests
6. Create pull request

---

## Resources

- **GitHub Repository**: https://github.com/SwiftStorm-Studio/AkkaraDB
- **Maven Repository**: https://repo.swiftstorm.dev/maven2/
- **Documentation**: [Table of Contents](../README.md)

---

Next: [Overview](./ABOUT.md) | [API Reference](./API_REFERENCE.md)

[Back to Index](../README.md)

---