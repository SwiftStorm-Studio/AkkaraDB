# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

AkkaraDBã®å†…éƒ¨è¨­è¨ˆã¨å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“š ç›®æ¬¡

- [å…¨ä½“æ§‹æˆ](#å…¨ä½“æ§‹æˆ)
- [ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](#ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
  - [MemTable](#memtable)
  - [WAL (Write-Ahead Log)](#wal-write-ahead-log)
  - [SSTable](#sstable)
  - [Stripe](#stripe)
  - [Manifest](#manifest)
- [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼)
- [ãƒ–ãƒ­ãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ](#ãƒ–ãƒ­ãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ)
- [ãƒªã‚«ãƒãƒªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ](#ãƒªã‚«ãƒãƒªãƒ¡ã‚«ãƒ‹ã‚ºãƒ )
- [ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³](#ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³)

---

## å…¨ä½“æ§‹æˆ

AkkaraDBã¯ä»¥ä¸‹ã®5ã¤ã®ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AkkaraDB Engine                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ MemTable â”‚â†’ â”‚ WAL â”‚â†’ â”‚ Stripe  â”‚â†’ â”‚Manifest â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚ flush                                       â”‚
â”‚       â†“                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚      SSTable        â”‚                            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”   â”‚                            â”‚
â”‚  â”‚  â”‚ L0 â”‚ L1 â”‚ L2 â”‚   â”‚                            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜   â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚          â”‚compactionâ”‚                               â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
baseDir/
â”œâ”€â”€ wal.akwal           # Write-Ahead Log
â”œâ”€â”€ manifest.akmf       # Manifestãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ sst/                # SSTableãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”œâ”€â”€ L0/            # Level 0 (æœ€æ–°)
â”‚   â”œâ”€â”€ L1/            # Level 1
â”‚   â””â”€â”€ L2/            # Level 2 ...
â””â”€â”€ lanes/              # Stripeãƒ¬ãƒ¼ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    â”œâ”€â”€ data_0.akd     # ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ¼ãƒ³0
    â”œâ”€â”€ data_1.akd     # ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ¼ãƒ³1
    â”œâ”€â”€ data_2.akd     # ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ¼ãƒ³2
    â”œâ”€â”€ data_3.akd     # ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ¼ãƒ³3
    â”œâ”€â”€ parity_0.akp   # ãƒ‘ãƒªãƒ†ã‚£ãƒ¬ãƒ¼ãƒ³0
    â””â”€â”€ parity_1.akp   # ãƒ‘ãƒªãƒ†ã‚£ãƒ¬ãƒ¼ãƒ³1
```

---

## ã‚³ã‚¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### MemTable

ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®æ›¸ãè¾¼ã¿ãƒãƒƒãƒ•ã‚¡ã€‚é«˜é€Ÿãªèª­ã¿æ›¸ãã‚’å®Ÿç¾ã—ã¾ã™ã€‚

#### è¨­è¨ˆ

- **ã‚·ãƒ£ãƒ¼ãƒ‰åŒ–ã•ã‚ŒãŸTreeMap**: ç«¶åˆã‚’æ¸›ã‚‰ã™ãŸã‚è¤‡æ•°ã‚·ãƒ£ãƒ¼ãƒ‰ã«åˆ†å‰²
- **ãƒãƒ«ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³**: åŒã˜ã‚­ãƒ¼ã®è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒ
- **ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å˜èª¿å¢—åŠ ï¼ˆu64ï¼‰

#### å†…éƒ¨æ§‹é€ 

```kotlin
class MemTable(
  private val shardCount: Int = Runtime
    .getRuntime()
    .availableProcessors()
    .coerceAtLeast(2)
    .coerceAtMost(8),
  private val thresholdBytesPerShard: Long = (64L * 1024 * 1024) / shardCount,
  private val onFlush: (List<MemRecord>) -> Unit
) {
    private val shards: Array<Shard>
  private val flusher: Flusher
  private val seqGen = AtomicLong(0)
}
```

å„ã‚·ãƒ£ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã‚’ç®¡ç†ï¼š

- `active`: ç¾åœ¨ã®æ›¸ãè¾¼ã¿å¯èƒ½ãªTreeMap
- `immutables`: ãƒ•ãƒ©ãƒƒã‚·ãƒ¥å¾…ã¡ã®ä¸å¤‰TreeMapãƒªã‚¹ãƒˆ
- `bytes`: ç¾åœ¨ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

#### ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

1. **ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶**:

- ã‚·ãƒ£ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒˆæ•°ãŒ`thresholdBytesPerShard`ã‚’è¶…é
- æ˜ç¤ºçš„ãª`flushHint()`å‘¼ã³å‡ºã—

2. **ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ—ãƒ­ã‚»ã‚¹**:
   ```kotlin
   // 1. activeã‚’ã‚·ãƒ¼ãƒ«ã—ã€immutablesã«è¿½åŠ 
   sealed = active
   immutables.add(sealed)
   active = TreeMap()
   
   // 2. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ•ãƒ©ãƒƒã‚·ãƒ£ãƒ¼ã«ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°
   queue.offer(batch)
   
   // 3. ã‚½ãƒ¼ãƒˆæ¸ˆã¿MemRecordã®ãƒªã‚¹ãƒˆã¨ã—ã¦æ›¸ãå‡ºã—
   val sorted = sealed.values.toList()
   onFlush(sorted)
   ```

3. **æ›¸ãå‡ºã—å…ˆ**:

- **SSTable**: L0ãƒ¬ãƒ™ãƒ«ã«ãƒ‡ã‚£ã‚¹ã‚¯æ°¸ç¶šåŒ–
- **Stripe**: å†—é•·æ€§ã®ãŸã‚ãƒ‘ãƒªãƒ†ã‚£ä»˜ãã§ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

---

### WAL (Write-Ahead Log)

ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ™‚ã®ãƒ‡ãƒ¼ã‚¿å¾©æ—§ã‚’ä¿è¨¼ã™ã‚‹å…ˆè¡Œæ›¸ãè¾¼ã¿ãƒ­ã‚°ã€‚

#### ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

å„ã‚¨ãƒ³ãƒˆãƒªã¯ä»¥ä¸‹ã®æ§‹é€ ï¼š

```
[u32 length] [payload bytes] [u32 crc32c]
```

**Payloadã®ç¨®é¡**:

- `WalOp.Add`: ã‚­ãƒ¼ãƒ»å€¤ãƒ»ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ»ãƒ•ãƒ©ã‚°ãƒ»keyFP64ãƒ»miniKey
- `WalOp.Delete`: ã‚­ãƒ¼ãƒ»ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãƒ»tombstoneãƒ•ãƒ©ã‚°ãƒ»keyFP64ãƒ»miniKey

#### ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒŸãƒƒãƒˆ

é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã®ãŸã‚ã€è¤‡æ•°ã®æ›¸ãè¾¼ã¿ã‚’ä¸€åº¦ã«fsyncã—ã¾ã™ã€‚

```kotlin
class WalWriter(
  private val groupN: Int = 64,
  private val groupTmicros: Long = 1_000,
  private val fastMode: Boolean = true
) {
  // Nå€‹ã®ã‚¨ãƒ³ãƒˆãƒªã¾ãŸã¯T ÂµsçµŒéã§fsync
}
```

**Fast Mode**:

- `force(false)`: fdatasyncç›¸å½“ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŒæœŸãªã—ï¼‰
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§ãƒãƒƒãƒå‡¦ç†

**Durable Mode**:

- `force(true)`: fsyncç›¸å½“ï¼ˆå®Œå…¨åŒæœŸï¼‰
- å„æ›¸ãè¾¼ã¿ã§å³åº§ã«åŒæœŸ

#### ãƒªã‚«ãƒãƒª

èµ·å‹•æ™‚ã«WALã‚’å†ç”Ÿã—ã¦MemTableã‚’å†æ§‹ç¯‰ï¼š

```kotlin
fun replay(walPath: Path, mem: MemTable): ReplayResult {
  // 1. WALã‚¨ãƒ³ãƒˆãƒªã‚’é †ã«èª­ã¿å–ã‚Š
  // 2. å„WalOpã‚’MemTableã«é©ç”¨
  // 3. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’å¾©å…ƒ
}
```

---

### SSTable

ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®ä¸å¤‰ãªé †åºä»˜ããƒ†ãƒ¼ãƒ–ãƒ«ã€‚

#### ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Data Blocks (32 KiB each)  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Block 0                  â”‚   â”‚
â”‚  â”‚  [u32 payloadLen]        â”‚   â”‚
â”‚  â”‚  [records...]            â”‚   â”‚
â”‚  â”‚  [padding]               â”‚   â”‚
â”‚  â”‚  [u32 crc32c]            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Block 1                  â”‚   â”‚
â”‚  â”‚  ...                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Index Block ('AKIX')       â”‚
â”‚  [u32 magic='AKIX']             â”‚
â”‚  [u32 entries]                  â”‚
â”‚  [array of (firstKey32, offset)]â”‚
â”‚  [u32 crc32c]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Bloom Filter ('AKBL')        â”‚
â”‚  [u32 magic='AKBL']             â”‚
â”‚  [u32 bitsSize]                 â”‚
â”‚  [u32 hashCount]                â”‚
â”‚  [bits array]                   â”‚
â”‚  [u32 crc32c]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Footer ('AKSS', 32B)      â”‚
â”‚  [u32 magic='AKSS']             â”‚
â”‚  [u8 ver=1] [u24 pad]           â”‚
â”‚  [u64 indexOff]                 â”‚
â”‚  [u64 bloomOff]                 â”‚
â”‚  [u32 entries]                  â”‚
â”‚  [u32 crc32c]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### AKHdr32 ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ32ãƒã‚¤ãƒˆï¼‰

å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯32ãƒã‚¤ãƒˆã®å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ã§å§‹ã¾ã‚Šã¾ã™ï¼š

```
Offset  Size  Field       Description
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0       2     kLen        ã‚­ãƒ¼é•· (u16)
2       4     vLen        å€¤é•· (u32)
6       8     seq         ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå· (u64)
14      1     flags       ãƒ•ãƒ©ã‚° (u8, 0x01=TOMBSTONE)
15      1     pad0        ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° (=0)
16      8     keyFP64     SipHash-2-4(key) (u64)
24      8     miniKey     keyå…ˆé ­8ãƒã‚¤ãƒˆã®LEè¡¨ç¾ (u64)
```

**miniKey**: ã‚­ãƒ¼ã®å…ˆé ­æœ€å¤§8ãƒã‚¤ãƒˆã‚’ãƒªãƒˆãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§è©°ã‚è¾¼ã¿ã€æ®‹ã‚Šã¯ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã€‚ç¯„å›²æ¤œç´¢ã®æœ€é©åŒ–ã«ä½¿ç”¨ã€‚

**keyFP64**: SipHash-2-4ã«ã‚ˆã‚‹ã‚­ãƒ¼ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã€‚Bloom Filterã®ã‚·ãƒ¼ãƒ‰ã‚„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é«˜é€Ÿãƒ—ãƒªãƒã‚§ãƒƒã‚¯ã«ä½¿ç”¨ã€‚

#### Index Block

å„ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ã®å…ˆé ­ã‚­ãƒ¼ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’æ ¼ç´ï¼š

```kotlin
data class IndexEntry(
  val firstKey32: ByteArray,  // ãƒ–ãƒ­ãƒƒã‚¯å†…ã®æœ€åˆã®ã‚­ãƒ¼ï¼ˆ32ãƒã‚¤ãƒˆï¼‰
  val blockOff: Long          // ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚ªãƒ•ã‚»ãƒƒãƒˆ
)
```

ç¯„å›²æ¤œç´¢æ™‚ã®é«˜é€Ÿãƒ–ãƒ­ãƒƒã‚¯ç‰¹å®šã«ä½¿ç”¨ã€‚

#### Bloom Filter

ã‚­ãƒ¼ã®å­˜åœ¨ã‚’ç¢ºç‡çš„ã«åˆ¤å®šï¼š

```kotlin
class BloomFilter(
  expectedInsertions: Long,
  fpRate: Double = 0.01  // å½é™½æ€§ç‡
) {
  private val bits: BitSet
  private val hashCount: Int
}
```

- **å½é™½æ€§**: ã‚ã‚Šï¼ˆå­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã‚’ã€Œå­˜åœ¨ã™ã‚‹ã€ã¨åˆ¤å®šï¼‰
- **å½é™°æ€§**: ãªã—ï¼ˆå­˜åœ¨ã™ã‚‹ã‚­ãƒ¼ã‚’ã€Œå­˜åœ¨ã—ãªã„ã€ã¨åˆ¤å®šã—ãªã„ï¼‰

---

### Stripe

å†—é•·æ€§ã®ãŸã‚ã®RAIDæ§˜ã®ã‚¹ãƒˆãƒ©ã‚¤ãƒ”ãƒ³ã‚°ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã€‚

#### æ§‹é€ 

```
Stripe = kå€‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ + må€‹ã®ãƒ‘ãƒªãƒ†ã‚£ãƒ–ãƒ­ãƒƒã‚¯

ä¾‹: k=4, m=2 ã®å ´åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ data_0 â”‚ data_1 â”‚ data_2 â”‚ data_3 â”‚ parity_0 â”‚ parity_1 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“        â†“        â†“        â†“          â†“          â†“
  Lane 0   Lane 1   Lane 2   Lane 3    Lane 4    Lane 5
```

#### ãƒ‘ãƒªãƒ†ã‚£ç¬¦å·åŒ–

**Reed-Solomonç¬¦å·**ï¼ˆm â‰¥ 1ï¼‰:

```kotlin
class RSParityCoder(private val m: Int) : ParityCoder {
  // kå€‹ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰må€‹ã®ãƒ‘ãƒªãƒ†ã‚£ã‚’ç”Ÿæˆ
  // æœ€å¤§må€‹ã®ãƒ¬ãƒ¼ãƒ³æ•…éšœã‹ã‚‰å¾©æ—§å¯èƒ½
}
```

#### ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒŸãƒƒãƒˆ

Stripeã‚‚ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒŸãƒƒãƒˆã‚’ä½¿ç”¨ï¼š

```kotlin
data class FlushPolicy(
  val maxBlocks: Int = 32,      // ãƒ–ãƒ­ãƒƒã‚¯æ•°é–¾å€¤
  val maxMicros: Long = 1000    // æ™‚é–“é–¾å€¤ï¼ˆÂµsï¼‰
)
```

**ã‚·ãƒ¼ãƒ«ãƒ—ãƒ­ã‚»ã‚¹**:

1. kå€‹ã®ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ãŒæƒã†
2. må€‹ã®ãƒ‘ãƒªãƒ†ã‚£ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¨ˆç®—
3. ã™ã¹ã¦ã®ãƒ¬ãƒ¼ãƒ³ã«æ›¸ãè¾¼ã¿
4. ã‚°ãƒ«ãƒ¼ãƒ—ã‚³ãƒŸãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã«å¾“ã£ã¦fsync

#### ãƒªã‚«ãƒãƒª

èµ·å‹•æ™‚ã«ãƒ¬ãƒ¼ãƒ³ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ï¼š

```kotlin
fun recover(): RecoveryResult {
  // 1. å„ãƒ¬ãƒ¼ãƒ³ã®ãƒ†ãƒ¼ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³
  // 2. CRCæ¤œè¨¼
  // 3. ä¸å®Œå…¨ãªã‚¹ãƒˆãƒ©ã‚¤ãƒ—ã‚’åˆ‡ã‚Šè©°ã‚
  // 4. ãƒ‘ãƒªãƒ†ã‚£ã«ã‚ˆã‚‹å¾©æ—§ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
}
```

---

### Manifest

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã™ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚°ã€‚

#### ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡

```kotlin
sealed class ManifestEvent {
  data class StripeCommit(val after: Long)
  data class SstSeal(val level: Int, val file: String, ...)
  data class Checkpoint(val name: String?, val stripe: Long?, val lastSeq: Long?)
    data class CompactionStart(val level: Int, val inputs: List<String>)
    data class CompactionEnd(val level: Int, val output: String, ...)
    data class SSTDelete(val file: String)
  data class Truncate(val note: String?)
  data class FormatBump(val major: Int, val minor: Int)
}
```

#### Fast Mode

ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§ãƒãƒƒãƒæ›¸ãè¾¼ã¿ï¼š

```kotlin
private fun runFlusher() {
  while (running.get() || q.isNotEmpty()) {
    // ãƒãƒƒãƒã‚’åé›†ï¼ˆNå€‹ã¾ãŸã¯T Âµsï¼‰
    val batch = collectBatch()

    // ä¸€åº¦ã«æ›¸ãè¾¼ã¿
    for (event in batch) {
      writeOne(ch, event)
    }
    ch.force(false)  // fdatasync

    // å®šæœŸçš„ã«force(true)ã§ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åŒæœŸ
    if (shouldStrongSync()) {
      ch.force(true)
    }
  }
}
```

#### ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒé–¾å€¤ã‚’è¶…ãˆã‚‹ã¨æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆï¼š

```
manifest.akmf
manifest.20250112-153045
manifest.20250112-160132
...
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### æ›¸ãè¾¼ã¿ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  put()  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. mem.nextSeq()    â”‚  ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ç”Ÿæˆ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. wal.append()     â”‚  WALã«æ›¸ãè¾¼ã¿ï¼ˆdurable before applyï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. mem.put()        â”‚  MemTableã«è¿½åŠ 
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“ (é–¾å€¤ã«é”ã—ãŸã‚‰)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. mem.flush()      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â†’ SSTableWriter â†’ L0/xxx.sst
     â”‚
     â””â”€â”€â†’ StripeWriter â†’ lanes/data_*, lanes/parity_*
          â”‚
          â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ manifest.sstSeal â”‚  ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èª­ã¿å–ã‚Šãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  get()  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. mem.get()         â”‚  MemTableã‹ã‚‰æ¤œç´¢ï¼ˆé«˜é€Ÿãƒ‘ã‚¹ï¼‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ è¦‹ã¤ã‹ã£ãŸï¼Ÿ
     â”œâ”€ Yes â†’ è¿”ã™
     â”‚
     â†“ No
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SSTableæ¤œç´¢       â”‚  æ–°ã—ã„é †ã«æ¤œç´¢
â”‚    L0 â†’ L1 â†’ L2 ...  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ è¦‹ã¤ã‹ã£ãŸï¼Ÿ
     â”œâ”€ Yes â†’ è¿”ã™
     â”‚
     â†“ No (useStripeForRead=true ã®å ´åˆ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Stripeæ¤œç´¢        â”‚  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
   è¿”ã™
```

### ç¯„å›²æ¤œç´¢ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  range()   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ä½œæˆ             â”‚
â”‚    - MemTableã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿       â”‚
â”‚    - å„SSTableã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. K-wayãƒãƒ¼ã‚¸                â”‚
â”‚    - ã‚­ãƒ¼é †ã«ã‚½ãƒ¼ãƒˆ           â”‚
â”‚    - åŒã˜ã‚­ãƒ¼ã¯æœ€æ–°ã‚’å„ªå…ˆ      â”‚
â”‚    - tombstoneã‚’ã‚¹ã‚­ãƒƒãƒ—      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
   Sequence<MemRecord>
```

---

## ãƒ–ãƒ­ãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ32 KiBï¼‰

```
Offset      Content
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0..3        payloadLen (u32 LE)
4..4+N      payload = ç¹°ã‚Šè¿”ã— {
              AKHdr32 (32B)
              + key bytes
              + value bytes
            }
4+N..-5     zero padding
-4..-1      CRC32C
```

### ãƒ¬ã‚³ãƒ¼ãƒ‰ãƒ‘ãƒƒã‚­ãƒ³ã‚°

```kotlin
class AkkBlockPacker {
  fun tryAppend(
    key: ByteBufferL,
    value: ByteBufferL,
    seq: U64,
    flags: Int,
    keyFP64: U64,
    miniKey: U64
  ): Boolean {
    val needed = 32 + key.remaining + value.remaining
    if (payloadPos + needed > PAYLOAD_LIMIT) {
      return false  // ãƒ–ãƒ­ãƒƒã‚¯ã«å…¥ã‚‰ãªã„
    }

    // 1. AKHdr32ã‚’æ›¸ãè¾¼ã¿
    buf.putHeader32(...)

    // 2. ã‚­ãƒ¼ã‚’æ›¸ãè¾¼ã¿
    buf.put(key)

    // 3. å€¤ã‚’æ›¸ãè¾¼ã¿
    buf.put(value)

    payloadPos += needed
    return true
  }

  fun endBlock() {
    // 1. payloadLenã‚’æ›¸ãè¾¼ã¿
    buf.at(0).i32 = payloadPos - 4

    // 2. ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
    buf.fillZero(BLOCK_SIZE - 4 - payloadPos)

    // 3. CRC32Cã‚’æ›¸ãè¾¼ã¿
    val crc = buf.crc32cRange(0, BLOCK_SIZE - 4)
    buf.at(BLOCK_SIZE - 4).i32 = crc

    // 4. å®Œæˆã—ãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’æ›¸ãå‡ºã—
    onBlockReady(buf)
  }
}
```

---

## ãƒªã‚«ãƒãƒªãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### èµ·å‹•æ™‚ã®å¾©æ—§ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Manifestã‚’ãƒ­ãƒ¼ãƒ‰   â”‚
â”‚    - æœ€å¾Œã®Checkpoint â”‚
â”‚    - ç”Ÿå­˜SSTä¸€è¦§      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. WALã‚’å†ç”Ÿ         â”‚
â”‚    - MemTableã‚’å†æ§‹ç¯‰ â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Stripeã‚’ãƒªã‚«ãƒãƒª  â”‚
â”‚    - CRCæ¤œè¨¼         â”‚
â”‚    - ãƒ‘ãƒªãƒ†ã‚£å¾©æ—§    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SSTableã‚’é–‹ã     â”‚
â”‚    - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹èª­è¾¼â”‚
â”‚    - Bloomèª­è¾¼       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚·ãƒŠãƒªã‚ª

#### ã‚·ãƒŠãƒªã‚ª1: MemTableãƒ•ãƒ©ãƒƒã‚·ãƒ¥ä¸­

```
çŠ¶æ…‹: MemTable â†’ SSTæ›¸ãè¾¼ã¿ä¸­ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥
å¾©æ—§:
1. WALã«æ›¸ãè¾¼ã¿ãŒæ®‹ã£ã¦ã„ã‚‹
2. WALå†ç”Ÿã§MemTableã‚’å†æ§‹ç¯‰
3. éƒ¨åˆ†çš„ãªSSTã¯ç„¡è¦–ï¼ˆManifestã«è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„ï¼‰
```

#### ã‚·ãƒŠãƒªã‚ª2: Stripeæ›¸ãè¾¼ã¿ä¸­

```
çŠ¶æ…‹: ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ¼ãƒ³ã¯æ›¸ãè¾¼ã¿æ¸ˆã¿ã€ãƒ‘ãƒªãƒ†ã‚£ãƒ¬ãƒ¼ãƒ³æ›¸ãè¾¼ã¿ä¸­ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥
å¾©æ—§:
1. Stripe.recover()ãŒä¸å®Œå…¨ãªã‚¹ãƒˆãƒ©ã‚¤ãƒ—ã‚’æ¤œå‡º
2. truncatedTail=trueã‚’è¿”ã™
3. ä¸å®Œå…¨ãªã‚¹ãƒˆãƒ©ã‚¤ãƒ—ã‚’åˆ‡ã‚Šè©°ã‚
4. ãƒ‘ãƒªãƒ†ã‚£ã‹ã‚‰å¾©æ—§ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
```

#### ã‚·ãƒŠãƒªã‚ª3: ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³ä¸­

```
çŠ¶æ…‹: æ–°ã—ã„SSTä½œæˆä¸­ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥
å¾©æ—§:
1. Manifestã« CompactionEnd ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„
2. å…¥åŠ›SSTã¯ã¾ã ã€Œç”Ÿå­˜ã€ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
3. éƒ¨åˆ†çš„ãªå‡ºåŠ›SSTã¯ç„¡è¦–
4. æ¬¡å›èµ·å‹•æ™‚ã«å†åº¦ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```

---

## ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³

### Leveled Compaction

```
L0: æ–°ã—ã„SSTï¼ˆæœªã‚½ãƒ¼ãƒˆã€ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã‚ã‚Šï¼‰
L1: ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ãªã—
L2: ã‚ˆã‚Šå¤§ããªã‚½ãƒ¼ãƒˆæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«
...
```

#### ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶

å„ãƒ¬ãƒ™ãƒ«ã§ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒé–¾å€¤ã‚’è¶…ãˆã‚‹ã¨å®Ÿè¡Œï¼š

```kotlin
class SSTCompactor(
  private val maxPerLevel: Int = 10
) {
  fun compact() {
    while (true) {
      val levelToCompact = levels.firstOrNull { level ->
        listSstFiles(levelPath(level)).size > maxPerLevel
      } ?: break

      compactLevel(levelToCompact)
    }
  }
}
```

#### ãƒãƒ¼ã‚¸ãƒ—ãƒ­ã‚»ã‚¹

```kotlin
private fun compactInto(
  inputs: List<Path>,
  output: Path,
  isBottomLevel: Boolean
): Triple<Long, String?, String?> {
  // 1. ã™ã¹ã¦ã®å…¥åŠ›SSTã‹ã‚‰ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚’ä½œæˆ
  val iterators = inputs.map { SSTIterator(it) }

  // 2. K-wayãƒãƒ¼ã‚¸
  val merged = merge(
    iterators = iterators,
    nowMillis = System.currentTimeMillis(),
    isBottomLevelCompaction = isBottomLevel,
    ttlMillis = 24L * 60 * 60 * 1000
  )

  // 3. æ–°ã—ã„SSTã«æ›¸ãå‡ºã—
  SSTableWriter(output).use { writer ->
    writer.writeAll(merged)
    writer.seal()
    }

  // 4. å…¥åŠ›SSTã‚’å‰Šé™¤
  inputs.forEach { Files.deleteIfExists(it) }
}
```

### Tombstone GC

å‰Šé™¤ã•ã‚ŒãŸã‚­ãƒ¼ã¯tombstoneã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã«å¤ã„tombstoneã‚’å‰Šé™¤ï¼š

```kotlin
private fun shouldDropTombstone(
  tomb: SSTRecord,
  nowMillis: Long,
  ttlMillis: Long,
  isBottomLevelCompaction: Boolean
): Boolean {
  // 1. å‰Šé™¤æ™‚åˆ»ã‚’å–å¾—ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¾ãŸã¯seqã‹ã‚‰æ¨å®šï¼‰
  val deleteAt = tomb.deleteAtMillisOrNull()

  // 2. TTLçµŒéã‚’ãƒã‚§ãƒƒã‚¯
  val expired = (deleteAt != null) && (nowMillis - deleteAt >= ttlMillis)

  // 3. æœ€ä¸‹å±¤ãƒ¬ãƒ™ãƒ«ã§ã®ã¿å‰Šé™¤å¯èƒ½
  val canDropHere = isBottomLevelCompaction

  return expired && canDropHere
}
```

**é‡è¦**: ä¸­é–“ãƒ¬ãƒ™ãƒ«ã§tombstoneã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ä¸‹å±¤ã«æ®‹ã£ã¦ã„ã‚‹å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¾©æ´»ã—ã¦ã—ã¾ã†ãŸã‚ã€æœ€ä¸‹å±¤ã§ã®ã¿å‰Šé™¤ã—ã¾ã™ã€‚

---

æ¬¡ã¸: [ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯](./BENCHMARKS.md) | [API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](./API_REFERENCE.md)

[æ¦‚è¦ã«æˆ»ã‚‹](./ABOUT.md)

---